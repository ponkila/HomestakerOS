# 3.1 WireGuard VPN Setup

This guide explains how to set up WireGuard VPN for your HomestakerOS node.
WireGuard allows you to connect your nodes via an encrypted virtual private network.

> **Warning:** ⚠️ This documentation does not include a WireGuard server setup.
You will need to set up your own WireGuard server separately.

## Prerequisites

- A working HomestakerOS node (see [Configure and Deploy](2.2-configure_deploy.md))
- An existing WireGuard server or infrastructure

## Prepare the WireGuard Configuration

The following steps should be performed directly on your HomestakerOS node:

1. **Generate a key pair**:

   ```bash
   wg genkey | tee clientPrivateKey | wg pubkey > clientPublicKey
   ```

   This will generate a private key, and derive a corresponding public key for it.
These keys will be saved as `clientPrivateKey` and `clientPublicKey`.

2. **Create and edit the WireGuard configuration file**:

   ```bash
   vim /mnt/nvme/secrets/wg0.conf
   ```

Your configuration should look something like this:

```ini
[Interface]
Address = 192.168.1.120/32
PrivateKey = 0F3OWcop34EQOW+UpJnPkPCb3FKZbCY73U9T8ovo70s=

[Peer]
PublicKey = r4JYV53tLdbS/Yp50jgZpLQ0/snMtqBaFftN/Vcseh8=
AllowedIPs = 192.168.1.0/24
Endpoint = ponkila.com:51820
PersistentKeepalive = 25
```

<details>
<summary><strong>Understanding the Configuration File</strong></summary>

#### [Interface]

- **Address** = `<serverIP>/32`: This is the IP address of the WireGuard server.
This is the IP address assigned to the server in the VPN network.
- **PrivateKey** = `<clientPrivateKey>`: This is the private key we just generated for the WireGuard client.
This key is used to authenticate the client.

#### [Peer]

- **PublicKey** = `<serverPublicKey>`: This is the public key of the WireGuard tunnel.
This key is used to authenticate the tunnel.
- **AllowedIPs** = `<AllowedIPs>`: This field specifies the IP addresses or IP ranges that are allowed to be accessed through the WireGuard tunnel.
- **Endpoint** = `<serverEndpoint>:51820`: This is the IP address or hostname of the WireGuard server endpoint.
The 51820 is the default WireGuard port.
- **PersistentKeepalive** = `25`: This option ensures that the connection stays active by sending a keepalive signal every 25 seconds.

For more information: <https://man7.org/linux/man-pages/man8/wg.8.html>
</details>

## Configure WireGuard in the Web UI

All we need to do is enable WireGuard and specify the path to the configuration file we created earlier:

1. **Access the Web UI**:
   - Start the backend and go to [https://homestakeros.com/](https://homestakeros.com/)
   - Set the flake URI and load your configurations

2. **Configure WireGuard**:
   - Go to the 'NixOS config' tab and select a node from the list
   - In the VPN section, enable WireGuard and set the configFile path to `/mnt/nvme/secrets/wg0.conf`

3. **Save and build**:
   - Save your configuration
   - Click the `#BUIDL` button to build your updated configuration
   - Download the boot media and deploy to your node

## Testing Your VPN Connection

After rebuilding and updating your node, you can test that the VPN connection is working:

1. **Check the WireGuard interface**:

   ```bash
   sudo wg show
   ```

2. **Test network connectivity**:

   ```bash
   ping 192.168.1.1  # Replace with an appropriate IP on your VPN
   ```

3. **Verify routing configuration**:

   ```bash
   ip route show
   ```

## Additional Resources

- [WireGuard Official Documentation](https://www.wireguard.com/quickstart/)
- [WireGuard Command Reference](https://man7.org/linux/man-pages/man8/wg.8.html)
